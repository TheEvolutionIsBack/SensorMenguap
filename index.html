<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deteksi Mengantuk & Mood â€” Full</title>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<style>
:root{
  --bg:#071226; --card:#0c1624; --muted:#9fb0c3; --accent:#06b6d4;
  --green:#22c55e; --red:#ef4444; --blue:#3b82f6;
}
body{margin:0; font-family:Inter,system-ui,Helvetica,Arial; background:linear-gradient(180deg,var(--bg),#041423); color:#e6f0f5; display:flex; flex-direction:column; align-items:center; padding:20px;}
h2{text-align:center;margin-bottom:12px;}
.wrap{display:grid; grid-template-columns:1fr 320px; gap:20px; width:100%; max-width:1100px;}
.card{background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(2,8,23,0.6); border:1px solid rgba(255,255,255,0.02);}
canvas{border-radius:12px; background:#000; width:100%; height:480px;}
.controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
button{padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--accent); color:#021018; font-weight:600;}
.sliderBox{margin-top:8px;}
label{font-size:13px;color:var(--muted);}
#status{margin-top:6px; font-size:14px;}
#notification{margin-top:12px; font-size:20px; text-align:center; position:relative;}
.badge{padding:4px 8px; border-radius:8px; font-weight:600;}
.bahagia{background:var(--green); color:#021018;}
.sedih{background:var(--blue); color:#fff;}
.marah{background:var(--red); color:#fff;}
#graph{margin-top:12px; height:100px; width:100%; background:#0c1624; border-radius:8px; overflow:hidden; position:relative;}
.bar{position:absolute; bottom:0; width:2px; background:var(--accent);}
</style>
</head>
<body>
<h2>Deteksi Mengantuk & Mood â€” Full</h2>
<div class="wrap">
  <div class="card">
    <canvas id="canvas"></canvas>
    <div class="controls">
      <button id="startBtn">Start Kamera</button>
      <button id="stopBtn">Stop Kamera</button>
      <button id="toggleCam">Toggle Kamera Visible</button>
    </div>
    <div class="sliderBox">
      <label>Mata tertutup Threshold (EAR): <span id="earVal">0.25</span></label>
      <input type="range" id="earSlider" min="0.15" max="0.35" step="0.01" value="0.25" style="width:100%;">
    </div>
    <div class="sliderBox">
      <label>Menguap Threshold (MAR): <span id="marVal">0.6</span></label>
      <input type="range" id="marSlider" min="0.4" max="0.8" step="0.01" value="0.6" style="width:100%;">
    </div>
    <div class="sliderBox">
      <label>Frames Trigger: <span id="frameVal">10</span></label>
      <input type="range" id="frameSlider" min="5" max="30" step="1" value="10" style="width:100%;">
    </div>
    <div id="status">Status: menunggu kamera...</div>
    <div id="notification"></div>
    <div id="graph"></div>
  </div>

  <div class="card">
    <h3>Ekspresi & Mood</h3>
    <div id="moodInfo">
      <p>Belum ada deteksi...</p>
    </div>
  </div>
</div>

<script>
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let videoElem = document.createElement('video'); 
videoElem.width=640; videoElem.height=480;
videoElem.autoplay=true; videoElem.playsInline=true;
videoElem.style.display='none';

let camera = null;
let faceMesh = null;

let cooldown=false;
let COOLDOWN_MS=7000;
let MAR_HISTORY=[], EAR_HISTORY=[];
let HISTORY_SIZE=30;
let MAR_THRESHOLD=0.6;
let EAR_THRESHOLD=0.25;
let FRAMES_TO_TRIGGER=10;
let lastMood=null;

const graphDiv=document.getElementById('graph');
const moodDiv=document.getElementById('moodInfo');
const notification=document.getElementById('notification');

function speak(text){
  const utter=new SpeechSynthesisUtterance(text);
  utter.lang='id-ID';
  speechSynthesis.speak(utter);
}

function mouthAspectRatio(landmarks){
  const top=landmarks[13], bottom=landmarks[14], left=landmarks[78], right=landmarks[308];
  return Math.hypot(top.x-bottom.x, top.y-bottom.y)/Math.hypot(left.x-right.x, left.y-right.y);
}
function eyeAspectRatio(landmarks){
  const L1=landmarks[159], L2=landmarks[145], L3=landmarks[33], L4=landmarks[133];
  return Math.hypot(L1.x-L2.x,L1.y-L2.y)/Math.hypot(L3.x-L4.x,L3.y-L4.y);
}

function detectMood(landmarks){
  const leftMouth=landmarks[61], rightMouth=landmarks[291];
  const mouthSlope=(rightMouth.y-leftMouth.y)/(rightMouth.x-leftMouth.x);
  const browInner=landmarks[168], browOuter=landmarks[151];
  const browDiff=browOuter.y-browInner.y;
  if(mouthSlope<-0.03) return {mood:'Bahagia', text:'Wah, senyum terus ya! Semangat!', className:'bahagia'};
  if(mouthSlope>0.03 && browDiff<-0.01) return {mood:'Marah', text:'Hati-hati, jangan marah-marah ya.', className:'marah'};
  if(mouthSlope>0.03 && browDiff>=-0.01) return {mood:'Sedih', text:'Sepertinya sedang sedih, semoga hari Anda membaik.', className:'sedih'};
  return null;
}

function checkYawning(){ return MAR_HISTORY.filter(m=>m>MAR_THRESHOLD).length>=FRAMES_TO_TRIGGER; }
function checkEyesClosed(){ return EAR_HISTORY.filter(e=>e<EAR_THRESHOLD).length>=FRAMES_TO_TRIGGER; }

function updateGraph(){
  graphDiv.innerHTML='';
  MAR_HISTORY.forEach((m,i)=>{
    const bar=document.createElement('div');
    bar.className='bar';
    bar.style.left=i*2+'px';
    bar.style.height=Math.min(m*200,100)+'px';
    graphDiv.appendChild(bar);
  });
  EAR_HISTORY.forEach((e,i)=>{
    const bar=document.createElement('div');
    bar.className='bar';
    bar.style.left=i*2+'px';
    bar.style.height=Math.min(e*200,100)+'px';
    bar.style.background='#ef4444';
    graphDiv.appendChild(bar);
  });
}

let sleepyStart=null;
function onResults(results){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(results.image,0,0,canvas.width,canvas.height);

  if(results.multiFaceLandmarks && results.multiFaceLandmarks.length>0){
    const landmarks=results.multiFaceLandmarks[0];
    const mar=mouthAspectRatio(landmarks);
    const ear=eyeAspectRatio(landmarks);
    MAR_HISTORY.push(mar); if(MAR_HISTORY.length>HISTORY_SIZE) MAR_HISTORY.shift();
    EAR_HISTORY.push(ear); if(EAR_HISTORY.length>HISTORY_SIZE) EAR_HISTORY.shift();

    updateGraph();

    const eyesClosed=checkEyesClosed();
    const yawning=checkYawning();
    const isSleepy=eyesClosed||yawning;

    // Track start time sleepy
    if(isSleepy){
      if(!sleepyStart) sleepyStart=Date.now();
      else if(Date.now()-sleepyStart>=3000 && !cooldown){
        notification.textContent='ðŸ˜´ Mengantuk terdeteksi!';
        speak("Anda Terdeteksi Mengantuk, Istirahat dulu sayang");
        cooldown=true;
        setTimeout(()=>{ cooldown=false; }, COOLDOWN_MS);
      }
    } else { sleepyStart=null; notification.textContent=''; }

    // Mood
    const moodData=detectMood(landmarks);
    if(moodData && moodData.mood!==lastMood && !cooldown){
      moodDiv.innerHTML=`<span class="badge ${moodData.className}">${moodData.text}</span>`;
      speak(moodData.text);
      lastMood=moodData.mood;
      cooldown=true;
      setTimeout(()=>{ cooldown=false; }, COOLDOWN_MS);
    }
  }
  ctx.restore();
}

// Slider binding
document.getElementById('earSlider').oninput=function(){ EAR_THRESHOLD=parseFloat(this.value); document.getElementById('earVal').textContent=this.value; };
document.getElementById('marSlider').oninput=function(){ MAR_THRESHOLD=parseFloat(this.value); document.getElementById('marVal').textContent=this.value; };
document.getElementById('frameSlider').oninput=function(){ FRAMES_TO_TRIGGER=parseInt(this.value); document.getElementById('frameVal').textContent=this.value; };

// Tombol start/stop
document.getElementById('startBtn').onclick = async ()=>{
  faceMesh = new FaceMesh({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
  faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.7, minTrackingConfidence:0.5});
  faceMesh.onResults(onResults);

  camera = new Camera(videoElem,{onFrame:async()=>{await faceMesh.send({image:videoElem});}, width:640, height:480});
  camera.start();
  document.getElementById('status').textContent='Status: kamera aktif, menunggu deteksi...';
}

// Stop kamera
document.getElementById('stopBtn').onclick = ()=>{
  if(camera) camera.stop();
  document.getElementById('status').textContent='Status: kamera berhenti.';
  notification.textContent='';
  MAR_HISTORY=[]; EAR_HISTORY=[]; lastMood=null;
  sleepyStart=null;
}

// Toggle kamera visible
document.getElementById('toggleCam').onclick = ()=>{
  if(videoElem.style.display==='none'){ videoElem.style.display='block'; } 
  else{ videoElem.style.display='none'; }
}
</script>
</body>
</html>
