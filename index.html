<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Deteksi Mengantuk + Mood</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
body {margin:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#071226; color:#e6f0f5;}
canvas {width:640px; height:480px; border-radius:10px;}
.controls {margin-top:10px;}
button {padding:8px 12px; margin:4px; border:none; border-radius:8px; cursor:pointer; background:#0c1624; color:#06b6d4;}
#status {margin-top:10px; font-size:14px;}
#notification {margin-top:10px; font-size:28px;}
</style>
</head>
<body>

<h2>Deteksi Mengantuk & Mood</h2>
<canvas id="canvas"></canvas>
<div class="controls">
  <button id="startBtn">Start Kamera</button>
  <button id="stopBtn">Stop Kamera</button>
</div>
<div id="status">Status: menunggu kamera...</div>
<div id="notification"></div>

<script>
let canvasElem = document.getElementById('canvas');
let canvasCtx = canvasElem.getContext('2d');
let startBtn = document.getElementById('startBtn');
let stopBtn = document.getElementById('stopBtn');
let statusElem = document.getElementById('status');
let notificationElem = document.getElementById('notification');

let videoElem = document.createElement('video'); 
videoElem.width=640; videoElem.height=480;
videoElem.autoplay=true; videoElem.playsInline=true; videoElem.style.display='none';

let camera = null;
let faceMesh = null;

let cooldown = false;
let COOLDOWN_MS = 5000;
let MAR_HISTORY = [];
let EAR_HISTORY = [];
let HISTORY_SIZE = 30;
let MAR_THRESHOLD = 0.6;
let EAR_THRESHOLD = 0.25;
let FRAMES_TO_TRIGGER = 10;

let lastMood = null; // track mood sebelumnya

function speak(text){
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang='id-ID';
  speechSynthesis.speak(utter);
}

function mouthAspectRatio(landmarks){
  const top = landmarks[13], bottom = landmarks[14], left = landmarks[78], right = landmarks[308];
  const vertical = Math.hypot(top.x-bottom.x, top.y-bottom.y);
  const horizontal = Math.hypot(left.x-right.x, left.y-right.y);
  return vertical/horizontal;
}

function eyeAspectRatio(landmarks){
  const L1=landmarks[159], L2=landmarks[145], L3=landmarks[33], L4=landmarks[133];
  const vert = Math.hypot(L1.x-L2.x,L1.y-L2.y);
  const hor = Math.hypot(L3.x-L4.x,L3.y-L4.y);
  return vert/hor;
}

// Mood detection sederhana
function detectMood(landmarks){
  const leftMouth = landmarks[61], rightMouth=landmarks[291];
  const topMouth=landmarks[13], bottomMouth=landmarks[14];
  const mouthSlope = (rightMouth.y - leftMouth.y)/(rightMouth.x - leftMouth.x);

  const browInner = landmarks[168], browOuter = landmarks[151];
  const browDiff = browOuter.y - browInner.y;

  if(mouthSlope < -0.03) return 'Bahagia';
  if(mouthSlope > 0.03 && browDiff < -0.01) return 'Marah';
  if(mouthSlope > 0.03 && browDiff >= -0.01) return 'Sedih';
  return null;
}

function checkYawning(){ return MAR_HISTORY.filter(m=>m>MAR_THRESHOLD).length>=FRAMES_TO_TRIGGER; }
function checkEyesClosed(){ return EAR_HISTORY.filter(e=>e<EAR_THRESHOLD).length>=FRAMES_TO_TRIGGER; }

function onResults(results){
  canvasCtx.save();
  canvasCtx.clearRect(0,0,canvasElem.width,canvasElem.height);
  canvasCtx.drawImage(results.image,0,0,canvasElem.width,canvasElem.height);

  if(results.multiFaceLandmarks && results.multiFaceLandmarks.length>0){
    const landmarks = results.multiFaceLandmarks[0];

    // update histories
    const mar=mouthAspectRatio(landmarks);
    const ear=eyeAspectRatio(landmarks);
    MAR_HISTORY.push(mar); if(MAR_HISTORY.length>HISTORY_SIZE) MAR_HISTORY.shift();
    EAR_HISTORY.push(ear); if(EAR_HISTORY.length>HISTORY_SIZE) EAR_HISTORY.shift();

    // cek mengantuk / mata tertutup
    if(!cooldown && (checkYawning() || checkEyesClosed())){
      notificationElem.textContent='ðŸ˜´ Mengantuk terdeteksi!';
      speak("Anda Terdeteksi Mengantuk, Istirahat dulu sayang");
      cooldown=true;
      setTimeout(()=>{cooldown=false; notificationElem.textContent='';}, COOLDOWN_MS);
    }

    // cek mood
    const mood = detectMood(landmarks);
    if(mood && mood!==lastMood && !cooldown){
      notificationElem.textContent='ðŸŽ­ Mood: '+mood;
      speak('Anda terlihat '+mood);
      lastMood=mood;
      cooldown=true;
      setTimeout(()=>{ cooldown=false; notificationElem.textContent='';}, COOLDOWN_MS);
    }
  }
  canvasCtx.restore();
}

startBtn.onclick = async()=>{
  faceMesh = new FaceMesh({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
  faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.7, minTrackingConfidence:0.5});
  faceMesh.onResults(onResults);

  camera = new Camera(videoElem,{onFrame:async()=>{await faceMesh.send({image:videoElem});}, width:640, height:480});
  camera.start();
  statusElem.textContent='Status: kamera aktif, menunggu deteksi...';
}

stopBtn.onclick = ()=>{
  if(camera) camera.stop();
  statusElem.textContent='Status: kamera berhenti.';
  notificationElem.textContent='';
  MAR_HISTORY=[]; EAR_HISTORY=[]; lastMood=null;
}
</script>

</body>
</html>
