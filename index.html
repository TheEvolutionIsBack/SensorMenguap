<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Deteksi Mengantuk Canggih</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
body {margin:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#071226; color:#e6f0f5;}
video, canvas {width:640px; height:480px; border-radius:10px; transform:scaleX(-1);}
.controls {margin-top:10px;}
button {padding:8px 12px; margin:4px; border:none; border-radius:8px; cursor:pointer; background:#0c1624; color:#06b6d4;}
#status {margin-top:10px; font-size:14px;}
#notification {margin-top:10px; font-size:28px;}
</style>
</head>
<body>

<h2>Deteksi Mengantuk Canggih</h2>
<div>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>
<div class="controls">
  <button id="startBtn">Start Kamera</button>
  <button id="stopBtn">Stop Kamera</button>
</div>
<div id="status">Status: menunggu kamera...</div>
<div id="notification"></div>

<audio id="alarmAudio" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
<audio id="voiceAudio" src="https://actions.google.com/sounds/v1/human_voices/yawn.ogg" preload="auto"></audio>

<script>
let videoElem = document.getElementById('video');
let canvasElem = document.getElementById('canvas');
let canvasCtx = canvasElem.getContext('2d');
let startBtn = document.getElementById('startBtn');
let stopBtn = document.getElementById('stopBtn');
let statusElem = document.getElementById('status');
let notificationElem = document.getElementById('notification');

let camera = null;
let faceMesh = null;
let alarmAudio = document.getElementById('alarmAudio');
let voiceAudio = document.getElementById('voiceAudio');

let cooldown = false;
let COOLDOWN_MS = 5000; // 5 detik
let MAR_HISTORY = [];
let HISTORY_SIZE = 30; // sekitar 1 detik
let MAR_THRESHOLD = 0.6; // threshold menguap
let FRAMES_TO_TRIGGER = 10; // minimal 10 frame berturut-turut MAR > threshold

function mouthAspectRatio(landmarks) {
  // titik mulut: 13 atas, 14 bawah, 78 kiri, 308 kanan (MediaPipe Face Mesh)
  const top = landmarks[13];
  const bottom = landmarks[14];
  const left = landmarks[78];
  const right = landmarks[308];

  const verticalDist = Math.hypot(top.x - bottom.x, top.y - bottom.y);
  const horizontalDist = Math.hypot(left.x - right.x, left.y - right.y);
  return verticalDist / horizontalDist;
}

function checkYawning() {
  let count = MAR_HISTORY.filter(m => m > MAR_THRESHOLD).length;
  return count >= FRAMES_TO_TRIGGER;
}

function onResults(results) {
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElem.width, canvasElem.height);
  canvasCtx.drawImage(results.image, 0, 0, canvasElem.width, canvasElem.height);

  if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
    const landmarks = results.multiFaceLandmarks[0];

    // Draw landmarks
    for (let i = 0; i < landmarks.length; i++) {
      const x = landmarks[i].x * canvasElem.width;
      const y = landmarks[i].y * canvasElem.height;
      canvasCtx.beginPath();
      canvasCtx.arc(x, y, 1.5, 0, 2 * Math.PI);
      canvasCtx.fillStyle = '#06b6d4';
      canvasCtx.fill();
    }

    const mar = mouthAspectRatio(landmarks);
    MAR_HISTORY.push(mar);
    if (MAR_HISTORY.length > HISTORY_SIZE) MAR_HISTORY.shift();

    if (checkYawning() && !cooldown) {
      notificationElem.textContent = 'ðŸ˜´ Mengantuk terdeteksi!';
      alarmAudio.play();
      voiceAudio.play();
      cooldown = true;
      setTimeout(() => { 
        cooldown = false; 
        notificationElem.textContent = '';
      }, COOLDOWN_MS);
    }
  }

  canvasCtx.restore();
}

startBtn.onclick = async () => {
  faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
  faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.7, minTrackingConfidence:0.5});
  faceMesh.onResults(onResults);

  camera = new Camera(videoElem, {
    onFrame: async () => { await faceMesh.send({image: videoElem}); },
    width: 640, height: 480
  });
  camera.start();
  statusElem.textContent = 'Status: kamera aktif, menunggu deteksi...';
}

stopBtn.onclick = () => {
  if(camera) camera.stop();
  statusElem.textContent = 'Status: kamera berhenti.';
  notificationElem.textContent = '';
  MAR_HISTORY = [];
}
</script>

</body>
</html>
